name: Python Syntax Check

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - '**.py'

concurrency:
  group: code-quality-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION: '3.8'
  CACHE_VERSION: 'v1'

jobs:
  detect-changes:
    name: Detect File Changes
    runs-on: ubuntu-latest
    outputs:
      has_python_changes: ${{ steps.changes.outputs.has_python_changes }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
      changed_files_json: ${{ steps.changes.outputs.changed_files_json }}
      should_run: ${{ steps.decision.outputs.should_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          fetch-depth: 0

      - name: Detect Python file changes
        id: changes
        run: |
          base_ref="origin/${{ github.event.pull_request.base.ref }}"
          changed_files=$(git diff --name-only --diff-filter=ACMRT $base_ref...HEAD | grep '\.py$' | head -50 || true)
          echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
          echo "$changed_files"

          if [[ -n "$changed_files" ]]; then
            echo "has_python_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$changed_files" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "changed_files_json=$(echo "$changed_files" | jq -R -s -c 'split("\n") | map(select(. != ""))')" >> $GITHUB_OUTPUT
          else
            echo "has_python_changes=false" >> $GITHUB_OUTPUT
            echo "changed_files=" >> $GITHUB_OUTPUT
            echo "changed_files_json=[]" >> $GITHUB_OUTPUT
          fi

      - name: Decide whether to run checks
        id: decision
        run: |
          if [[ "${{ steps.changes.outputs.has_python_changes }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_run == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python*/site-packages
          key: ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-pip-

      - name: Cache code quality tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pyright
            ~/.mypy_cache
            ~/.cache/ruff
            ~/.cache/pylint
          key: ${{ runner.os }}-tools-${{ env.CACHE_VERSION }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-tools-${{ env.CACHE_VERSION }}-${{ env.PYTHON_VERSION }}-
            ${{ runner.os }}-tools-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-tools-

      - name: Install dependencies and tools
        run: |
          python -m pip install --upgrade pip
          pip install --cache-dir ~/.cache/pip -r requirements.txt
          tools=("ruff" "pylint" "pyright" "mypy")
          for tool in "${tools[@]}"; do
            if ! pip show "$tool" > /dev/null 2>&1; then
              pip install --cache-dir ~/.cache/pip "$tool"
            fi
          done
          echo "tool versionï¼š"
          ruff --version
          pylint --version
          pyright --version
          mypy --version

      - name: Prepare file list
        id: files
        run: |
          files="${{ needs.detect-changes.outputs.changed_files }}"
          if [[ -z "$files" ]]; then
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æ£€æŸ¥"
            echo "files_exist=false" >> $GITHUB_OUTPUT
          else
            echo "files_exist=true" >> $GITHUB_OUTPUT
            echo "æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨ï¼š"
            echo "$files"
          fi

      - name: Run Ruff check
        uses: astral-sh/ruff-action@v3
        id: ruff
        if: steps.files.outputs.files_exist == 'true'
        with:
          args: check ${{ needs.detect-changes.outputs.changed_files }}
        continue-on-error: true

      - name: Run Pyright check
        uses: jakebailey/pyright-action@v2
        id: pyright
        if: steps.files.outputs.files_exist == 'true'
        with:
          annotate: errors
          pylance-version: latest-release
          extra-args: ${{ needs.detect-changes.outputs.changed_files }}
        continue-on-error: true

      - name: Run PyLint check
        id: pylint
        if: steps.files.outputs.files_exist == 'true'
        continue-on-error: true
        run: |
          echo "ğŸ” è¿è¡Œ PyLint æ£€æŸ¥..."
          files="${{ needs.detect-changes.outputs.changed_files }}"
          if echo "$files" | xargs pylint --errors-only --disable=no-member,no-name-in-module,E0601,E0606,import-error --output-format=text --reports=no > pylint_output.txt 2>&1 && [[ ! -s pylint_output.txt ]]; then
            echo "âœ… PyLint æ£€æŸ¥é€šè¿‡"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ PyLint å‘ç°é—®é¢˜"
            echo "has_issues=true" >> $GITHUB_OUTPUT
          fi

      - name: Run MyPy check
        id: mypy
        if: steps.files.outputs.files_exist == 'true'
        continue-on-error: true
        run: |
          echo "ğŸ” è¿è¡Œ MyPy æ£€æŸ¥..."
          files="${{ needs.detect-changes.outputs.changed_files }}"
          if echo "$files" | xargs mypy --ignore-missing-imports --no-strict-optional --show-error-codes --disable-error-code=name-defined --disable-error-code=attr-defined --disable-error-code=import > mypy_output.txt 2>&1 && (grep -q "Success: no issues found" mypy_output.txt || [[ ! -s mypy_output.txt ]]); then
            echo "âœ… MyPy æ£€æŸ¥é€šè¿‡"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ MyPy å‘ç°é—®é¢˜"
            echo "has_issues=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate report
        id: code-quality
        if: always() && steps.files.outputs.files_exist == 'true'
        run: |
          report="## ğŸ” é™æ€æ£€æŸ¥ç»“æœ\n\n"
          report+="**æ£€æŸ¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')\n"
          report+="**è§¦å‘äº‹ä»¶**: ${{ github.event_name }}\n"
          report+="**æ£€æŸ¥æ–‡ä»¶æ•°**: $(echo '${{ needs.detect-changes.outputs.changed_files_json }}' | jq '. | length')\n\n"
          
          all_passed=true
          
          # æ£€æŸ¥ Ruff ç»“æœ
          if [[ "${{ steps.ruff.outcome }}" == "failure" ]]; then
            report+="### âŒ Ruff å‘ç°é—®é¢˜\n\n"
            report+="è¯·æŸ¥çœ‹ä¸Šæ–¹çš„ Problem Matchers æ³¨é‡Šè·å–è¯¦ç»†ä¿¡æ¯ã€‚\n\n"
            all_passed=false
          else
            report+="### âœ… Ruff æ£€æŸ¥é€šè¿‡\n\n"
          fi
          
          # æ£€æŸ¥ Pyright ç»“æœ
          if [[ "${{ steps.pyright.outcome }}" == "failure" ]]; then
            report+="### âŒ Pyright å‘ç°é—®é¢˜\n\n"
            report+="è¯·æŸ¥çœ‹ä¸Šæ–¹çš„ Problem Matchers æ³¨é‡Šè·å–è¯¦ç»†ä¿¡æ¯ã€‚\n\n"
            all_passed=false
          else
            report+="### âœ… Pyright æ£€æŸ¥é€šè¿‡\n\n"
          fi
          
          # æ£€æŸ¥ PyLint ç»“æœ
          if [[ "${{ steps.pylint.outputs.has_issues }}" == "true" ]]; then
            report+="### âŒ PyLint å‘ç°é—®é¢˜\n\n"
            report+="<details><summary>æŸ¥çœ‹è¯¦æƒ…</summary>\n\n"
            report+="\`\`\`\n"
            report+="$(cat pylint_output.txt | head -50)\n"
            report+="\`\`\`\n\n"
            report+="</details>\n\n"
            all_passed=false
          else
            report+="### âœ… PyLint æ£€æŸ¥é€šè¿‡\n\n"
          fi
          
          # æ£€æŸ¥ MyPy ç»“æœ
          if [[ "${{ steps.mypy.outputs.has_issues }}" == "true" ]]; then
            report+="### âŒ MyPy å‘ç°é—®é¢˜\n\n"
            report+="<details><summary>æŸ¥çœ‹è¯¦æƒ…</summary>\n\n"
            report+="\`\`\`\n"
            report+="$(cat mypy_output.txt | head -50)\n"
            report+="\`\`\`\n\n"
            report+="</details>\n\n"
            all_passed=false
          else
            report+="### âœ… MyPy æ£€æŸ¥é€šè¿‡\n\n"
          fi
          
          if [[ "$all_passed" == "true" ]]; then
            report+="## ğŸ‰ æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼\n\n"
          else
            report+="## âš ï¸ å‘ç°äº†ä¸€äº›é—®é¢˜\n\n"
            report+="ğŸ’¡ **æç¤º**: Ruff å’Œ Pyright çš„é—®é¢˜å·²é€šè¿‡ Problem Matchers åœ¨æ–‡ä»¶ä¸­æ ‡æ³¨ï¼Œè¯·æŸ¥çœ‹å…·ä½“æ–‡ä»¶ä½ç½®çš„æ³¨é‡Šã€‚\n\n"
          fi
          
          report+="\n----------\n"
          report+="*å–µ*"
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$report" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "all_passed=$all_passed" >> $GITHUB_OUTPUT

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'é™æ€æ£€æŸ¥ç»“æœ'

      - name: Post or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body: ${{ steps.code-quality.outputs.report }}
          edit-mode: replace
          
      - name: Set check status
        run: |
          if [[ "${{ steps.code-quality.outputs.all_passed }}" == "true" ]]; then
            exit 0
          else
            exit 0
          fi